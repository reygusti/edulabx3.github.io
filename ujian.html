<script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz-KYpfaeSN0gVBTKlS-21ZmD1JeVYjjDgoQgotxUCXh5k9XHFUxEv1LJaqeB3FZfGI/exec";
        const ADMIN_PASSWORD = "123"; 
        const EXAM_DURATION = 10; 

        // --- STATE & PERSISTENCE ---
        let userData = { nama: "", mapel: "", mapelCode: "", kelas: "X-3" };
        let currentQ = 0;
        let userAnswers = [];
        let timerInterval;
        let isExamActive = false;

        // CEK STATUS SAAT PAGE LOAD (Fix masalah Refresh)
        window.onload = function() {
            if(localStorage.getItem('STATUS_UJIAN') === 'LOCKED') {
                document.getElementById('setup-screen').style.display = 'none';
                document.getElementById('block-screen').style.display = 'flex';
                // Tidak perlu fullscreen di sini, biarkan terkunci
            }
        };

        const questionsDB = {
            informatika: [
                { q: "Apa fungsi utama CPU?", o: ["Menyimpan data", "Memproses data", "Mencetak data"], a: 1 },
                { q: "Penyimpanan sementara disebut...", o: ["Harddisk", "Flashdisk", "RAM"], a: 2 },
                { q: "Sistem operasi open source adalah...", o: ["Windows", "Linux", "MacOS"], a: 1 },
                { q: "Tombol copy adalah...", o: ["Ctrl+C", "Ctrl+V", "Ctrl+X"], a: 0 },
                { q: "IoT singkatan dari...", o: ["Internet of Technology", "Internet of Things", "Input Output Things"], a: 1 }
            ],
            matematika: [
                { q: "10 + 10 = ...", o: ["10", "20", "30"], a: 1 },
                { q: "Akar 9 = ...", o: ["2", "3", "4"], a: 1 },
                { q: "Luas persegi sisi 5...", o: ["20", "25", "30"], a: 1 },
                { q: "Sudut siku-siku...", o: ["45", "90", "180"], a: 1 },
                { q: "1 jam berapa menit?", o: ["60", "100", "3600"], a: 0 }
            ],
            bindo: [
                { q: "Sinonim Senang...", o: ["Sedih", "Bahagia", "Marah"], a: 1 },
                { q: "Ibukota Indonesia...", o: ["Bandung", "Surabaya", "Jakarta"], a: 2 },
                { q: "Antonim Besar...", o: ["Kecil", "Luas", "Lebar"], a: 0 },
                { q: "Subjek kalimat...", o: ["Pelaku", "Pekerjaan", "Keterangan"], a: 0 },
                { q: "Tanda tanya untuk...", o: ["Perintah", "Tanya", "Seru"], a: 1 }
            ]
        };
        let activeQuestions = [];

        // --- UI UTILS ---
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(e, id) { if(e.target.classList.contains('modal-overlay')) document.getElementById(id).classList.remove('active'); }
        function forceClose(id) { document.getElementById(id).classList.remove('active'); }

        function selectOption(type, label, value) {
            if(type === 'mapel') {
                userData.mapel = label;
                userData.mapelCode = value;
                document.getElementById('text-mapel').textContent = label;
                document.getElementById('trigger-mapel').classList.remove('placeholder');
                forceClose('modal-mapel');
            } else if (type === 'nama') {
                userData.nama = label;
                document.getElementById('text-nama').textContent = label;
                document.getElementById('trigger-nama').classList.remove('placeholder');
                forceClose('modal-nama');
            }
        }

        // --- CORE EXAM LOGIC ---
        function startExam() {
            if(!userData.mapel || !userData.nama) { alert("Data belum lengkap!"); return; }
            
            // Script ini MENGHARUSKAN Fullscreen (sesuai kode yang Anda berikan)
            document.documentElement.requestFullscreen().then(() => {
                activeQuestions = questionsDB[userData.mapelCode] || questionsDB.informatika;
                userAnswers = new Array(activeQuestions.length).fill(null);
                
                document.getElementById('setup-screen').style.display = 'none';
                document.getElementById('quiz-screen').style.display = 'flex';
                document.getElementById('quiz-mapel-name').textContent = userData.mapel;
                
                renderQuestion();
                startTimer(EXAM_DURATION * 60);
                isExamActive = true;
                activateSecurity();

            }).catch(() => alert("Wajib Fullscreen! Izinkan browser."));
        }

        function renderQuestion() {
            const q = activeQuestions[currentQ];
            let html = `<div class="question-text">Soal ${currentQ+1}<br>${q.q}</div>`;
            q.o.forEach((opt, idx) => {
                const isSelected = userAnswers[currentQ] === idx ? 'selected' : '';
                html += `<div class="option-card ${isSelected}" onclick="saveAnswer(${idx})"><div class="option-circle"></div> <div>${opt}</div></div>`;
            });
            document.getElementById('question-container').innerHTML = html;
            
            const btnNext = document.getElementById('btn-next-text');
            if(currentQ === activeQuestions.length - 1) {
                btnNext.textContent = "Kirim";
                btnNext.style.background = "#10B981";
            } else {
                btnNext.textContent = "Lanjut";
                btnNext.style.background = "#4F46E5";
            }
        }

        function saveAnswer(idx) { userAnswers[currentQ] = idx; renderQuestion(); }
        function nextQuestion() { 
            if(currentQ < activeQuestions.length - 1) { currentQ++; renderQuestion(); } 
            else { openModal('modal-confirm'); } 
        }
        function prevQuestion() { if(currentQ > 0) { currentQ--; renderQuestion(); } }

        function openGrid() {
            const gridBox = document.getElementById('grid-box');
            gridBox.innerHTML = '';
            userAnswers.forEach((ans, idx) => {
                const isAnswered = ans !== null ? 'answered' : '';
                const isActive = idx === currentQ ? 'active' : '';
                gridBox.innerHTML += `<div class="grid-item ${isAnswered} ${isActive}" onclick="jumpTo(${idx})">${idx+1}</div>`;
            });
            openModal('modal-grid');
        }
        function jumpTo(i) { currentQ = i; renderQuestion(); forceClose('modal-grid'); }

        function processSubmission() {
            forceClose('modal-confirm');
            document.getElementById('loading-overlay').style.display = 'flex';
            isExamActive = false; clearInterval(timerInterval);

            // Clean Storage
            localStorage.removeItem('STATUS_UJIAN');

            let score = 0;
            const points = 100 / activeQuestions.length;
            activeQuestions.forEach((q, i) => { if(userAnswers[i] === q.a) score += points; });
            const finalScore = Math.round(score);

            fetch(SCRIPT_URL, {
                method: 'POST', mode: 'no-cors',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ nama: userData.nama, kelas: userData.kelas, mapel: userData.mapel, nilai: finalScore })
            }).then(() => {
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('final-score-display').textContent = finalScore;
                openModal('modal-success');
            }).catch(() => {
                alert("Nilai lokal: " + finalScore); location.reload();
            });
        }

        // --- SECURITY ---
        function activateSecurity() {
            document.addEventListener('fullscreenchange', () => { if(!document.fullscreenElement && isExamActive) lockExam(); });
            document.addEventListener('visibilitychange', () => { if(document.visibilityState === 'hidden' && isExamActive) lockExam(); });
            window.addEventListener('resize', () => { if(isExamActive && Math.abs(window.outerWidth - screen.width) > 50) lockExam(); });
            window.addEventListener('blur', () => { if(isExamActive) lockExam(); });
        }

        function lockExam() {
            isExamActive = false;
            // SET STATUS LOKAL: TERKUNCI
            localStorage.setItem('STATUS_UJIAN', 'LOCKED');
            
            document.getElementById('quiz-screen').style.display = 'none';
            document.getElementById('block-screen').style.display = 'flex';
        }

        function openUnlockModal() {
            document.getElementById('password-error').style.display = 'none';
            document.getElementById('admin-password').value = '';
            openModal('modal-unlock');
        }

        function checkAdminPassword() {
            const input = document.getElementById('admin-password').value;
            if(input === ADMIN_PASSWORD) {
                // Hapus status locked, lalu reload agar ujian reset dari awal
                localStorage.removeItem('STATUS_UJIAN');
                location.reload(); 
            } else {
                document.getElementById('password-error').style.display = 'block';
            }
        }

        function startTimer(duration) {
            let timer = duration;
            const display = document.getElementById('timer-display');
            timerInterval = setInterval(() => {
                const m = String(Math.floor(timer / 60)).padStart(2,'0');
                const s = String(timer % 60).padStart(2,'0');
                display.textContent = `${m}:${s}`;
                if(--timer < 0) { clearInterval(timerInterval); processSubmission(); }
            }, 1000);
        }

        document.onkeydown = function(e) { if(e.keyCode == 123) return false; }
    </script>
